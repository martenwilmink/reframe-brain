((e,r)=>{"function"==typeof define&&define.amd?define(["leaflet"],r):r("object"==typeof module&&module.exports?require("leaflet"):e.L)})(this,function(n,o){n.MarkerClusterGroup.LayerSupport=n.MarkerClusterGroup.extend({options:{singleAddRemoveBufferDuration:0},initialize:function(e){n.MarkerClusterGroup.prototype.initialize.call(this,e),this._featureGroup=new r,this._featureGroup.addEventParent(this),this._nonPointGroup=new r,this._nonPointGroup.addEventParent(this),this._layers={},this._proxyLayerGroups={},this._proxyLayerGroupsNeedRemoving={},this._singleAddRemoveBuffer=[]},checkIn:function(e){e=this._toArray(e);return this._checkInGetSeparated(e),this},checkOut:function(e){for(var r,e=this._toArray(e),e=this._separateSingleFromGroupLayers(e,{groups:[],singles:[]}),o=e.groups,t=e.singles,i=0;i<t.length;i++)r=t[i],delete this._layers[n.stamp(r)],delete r._mcgLayerSupportGroup;for(this._originalRemoveLayers(t),i=0;i<o.length;i++)r=o[i],this._dismissProxyLayerGroup(r);return this},addLayers:function(e){var r,o,t,e=this._toArray(e),e=this._checkInGetSeparated(e),i=e.groups;for(this._originalAddLayers(e.singles),r=0;r<i.length;r++)o=i[r],t=n.stamp(o),this._proxyLayerGroups[t]=o,delete this._proxyLayerGroupsNeedRemoving[t],this._map&&this._map._originalAddLayer(o)},addLayer:function(e){return this._bufferSingleAddRemove(e,"addLayers"),this},_originalAddLayer:n.MarkerClusterGroup.prototype.addLayer,_originalAddLayers:n.MarkerClusterGroup.prototype.addLayers,removeLayers:function(e){var r,o,e=this._toArray(e),e=this._separateSingleFromGroupLayers(e,{groups:[],singles:[]}),t=e.groups,i=0;for(this._originalRemoveLayers(e.singles);i<t.length;i++)r=t[i],o=n.stamp(r),delete this._proxyLayerGroups[o],this._map?this._map._originalRemoveLayer(r):this._proxyLayerGroupsNeedRemoving[o]=r;return this},removeLayer:function(e){return this._bufferSingleAddRemove(e,"removeLayers"),this},_originalRemoveLayer:n.MarkerClusterGroup.prototype.removeLayer,_originalRemoveLayers:n.MarkerClusterGroup.prototype.removeLayers,onAdd:function(e){e._originalAddLayer=e._originalAddLayer||e.addLayer,e._originalRemoveLayer=e._originalRemoveLayer||e.removeLayer,n.extend(e,a);var r,o,t,i=this._removePreAddedLayers(e);for(r in this._originalOnAdd.call(this,e),this._proxyLayerGroups)o=this._proxyLayerGroups[r],e._originalAddLayer(o);for(r in this._proxyLayerGroupsNeedRemoving)o=this._proxyLayerGroupsNeedRemoving[r],e._originalRemoveLayer(o),delete this._proxyLayerGroupsNeedRemoving[r];for(t=0;t<i.length;t++)e.addLayer(i[t])},_originalOnAdd:n.MarkerClusterGroup.prototype.onAdd,_bufferSingleAddRemove:function(e,r){var o,t=this.options.singleAddRemoveBufferDuration;0<t?(this._singleAddRemoveBuffer.push({type:r,layer:e}),this._singleAddRemoveBufferTimeout||(o=n.bind(this._processSingleAddRemoveBuffer,this),this._singleAddRemoveBufferTimeout=setTimeout(o,t))):this[r](e)},_processSingleAddRemoveBuffer:function(){for(var e,r,o=this._singleAddRemoveBuffer,t=0,i=[];t<o.length;t++)e=o[t],r=r||e.type,e.type===r?i.push(e.layer):(this[r](i),r=e.type,i=[e.layer]);this[r](i),o.length=0,clearTimeout(this._singleAddRemoveBufferTimeout),this._singleAddRemoveBufferTimeout=null},_checkInGetSeparated:function(e){for(var r,e=this._separateSingleFromGroupLayers(e,{groups:[],singles:[]}),o=e.groups,t=e.singles,i=0;i<o.length;i++)r=o[i],this._recruitLayerGroupAsProxy(r);for(i=0;i<t.length;i++)r=t[i],this._removeFromOtherGroupsOrMap(r),(this._layers[n.stamp(r)]=r)._mcgLayerSupportGroup=this;return e},_separateSingleFromGroupLayers:function(e,r){for(var o,t=r.groups,i=r.singles,a=n.Util.isArray,s=0;s<e.length;s++)(o=e[s])instanceof n.LayerGroup?(t.push(o),this._separateSingleFromGroupLayers(o.getLayers(),r)):a(o)?this._separateSingleFromGroupLayers(o,r):i.push(o);return r},_recruitLayerGroupAsProxy:function(e){var r=e._proxyMcgLayerSupportGroup;if(r){if(r===this)return;r.checkOut(e)}else this._removeFromOwnMap(e);e._proxyMcgLayerSupportGroup=this,e._originalAddLayer=e._originalAddLayer||e.addLayer,e._originalRemoveLayer=e._originalRemoveLayer||e.removeLayer,e._originalOnAdd=e._originalOnAdd||e.onAdd,e._originalOnRemove=e._originalOnRemove||e.onRemove,n.extend(e,t)},_dismissProxyLayerGroup:function(e){var r;e._proxyMcgLayerSupportGroup!==o&&e._proxyMcgLayerSupportGroup===this&&(delete e._proxyMcgLayerSupportGroup,e.addLayer=e._originalAddLayer,e.removeLayer=e._originalRemoveLayer,e.onAdd=e._originalOnAdd,e.onRemove=e._originalOnRemove,r=n.stamp(e),delete this._proxyLayerGroups[r],delete this._proxyLayerGroupsNeedRemoving[r],this._removeFromOwnMap(e))},_removeFromOtherGroupsOrMap:function(e){var r=e._mcgLayerSupportGroup;r?r!==this&&r.checkOut(e):e.__parent?e.__parent._group.removeLayer(e):this._removeFromOwnMap(e)},_removeFromOwnMap:function(e){e._map&&e._map.removeLayer(e)},_removePreAddedLayers:function(e){var r,o,t=this._layers,i=[];for(o in t)r=t[o],r._map&&(i.push(r),e._originalRemoveLayer(r));return i},_toArray:function(e){return n.Util.isArray(e)?e:[e]}});var r=n.FeatureGroup.extend({addLayer:function(e){if(this.hasLayer(e))return this;e.addEventParent(this);var r=n.stamp(e);return this._layers[r]=e,this._map&&this._map._originalAddLayer(e),this.fire("layeradd",{layer:e})},removeLayer:function(e){if(!this.hasLayer(e))return this;(e=e in this._layers?this._layers[e]:e).removeEventParent(this);var r=n.stamp(e);return this._map&&this._layers[r]&&this._map._originalRemoveLayer(this._layers[r]),delete this._layers[r],this.fire("layerremove",{layer:e})},onAdd:function(e){this._map=e,this.eachLayer(e._originalAddLayer,e)},onRemove:function(e){this.eachLayer(e._originalRemoveLayer,e),this._map=null}}),t={addLayer:function(e){var r=this.getLayerId(e);return this._layers[r]=e,this._map?this._proxyMcgLayerSupportGroup.addLayer(e):this._proxyMcgLayerSupportGroup.checkIn(e),this},removeLayer:function(e){var r=e in this._layers?e:this.getLayerId(e);return this._proxyMcgLayerSupportGroup.removeLayer(e),delete this._layers[r],this},onAdd:function(){this._proxyMcgLayerSupportGroup.addLayers(this.getLayers())},onRemove:function(){this._proxyMcgLayerSupportGroup.removeLayers(this.getLayers())}},a={addLayer:function(e){return(e._mcgLayerSupportGroup||this)._originalAddLayer(e)},removeLayer:function(e){return(e._mcgLayerSupportGroup||this)._originalRemoveLayer(e)}};n.markerClusterGroup.layerSupport=function(e){return new n.MarkerClusterGroup.LayerSupport(e)}});